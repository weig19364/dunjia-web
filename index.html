<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>éç”²å½’ä¸€ V37 (åŒæ¨¡æ’ç›˜ç‰ˆ)</title>
    
    <link rel="stylesheet" href="https://pyscript.net/releases/2023.05.1/pyscript.css" />
    <script defer src="https://pyscript.net/releases/2023.05.1/pyscript.js"></script>

    <style>
        py-script, py-config { display: none !important; }

        :root { 
            --bg: #0f172a; --panel: #1e293b; --text: #cbd5e1; 
            --accent: #38bdf8; --gold: #f59e0b; --red: #f87171; --border: #334155; --green: #4ade80;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { 
            background: var(--bg); color: var(--text); 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            margin: 0; padding: 10px; overflow-x: hidden; display: flex; justify-content: center;
        }
        .app { width: 100%; max-width: 400px; margin: 0 auto; padding-bottom: 20px;}
        .status-bar { display: flex; justify-content: space-between; font-size: 0.75rem; color: #64748b; margin-bottom: 8px; padding: 0 4px; }
        .controls { background: var(--panel); padding: 12px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2); }
        .input-group { display: flex; gap: 8px; margin-bottom: 10px; }
        input[type="datetime-local"] { flex: 1; background: #0f172a; border: 1px solid #475569; color: #fff; padding: 8px; border-radius: 8px; font-size: 0.95rem; outline: none; }
        select { background: #0f172a; border: 1px solid #475569; color: var(--gold); padding: 8px; border-radius: 8px; font-size: 0.95rem; outline: none; font-weight: bold;}
        .icon-btn { background: #334155; border: 1px solid #475569; color: #fff; border-radius: 8px; width: 40px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .btn { width: 100%; background: linear-gradient(135deg, #0284c7, #2563eb); border: none; color: white; padding: 12px; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; }
        .btn:disabled { background: #334155; color: #94a3b8; cursor: not-allowed; opacity: 0.7; }
        .card { background: var(--panel); border-radius: 12px; padding: 12px 16px; margin-bottom: 10px; border: 1px solid var(--border); }
        .info-row { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 6px; align-items: center;}
        .highlight { color: var(--gold); font-weight: bold; }
        .accent { color: var(--accent); font-weight: bold; }
        .red-text { color: var(--red); font-weight: bold; }
        .green-text { color: var(--green); font-weight: bold; }
        .data-val { color: #fff; font-family: monospace; font-size: 0.85rem;}
        
        /* ä¸“ç”¨æ˜¾ç¤ºåŒºåŸŸ */
        #zhirun-info-box { background: rgba(0, 0, 0, 0.2); padding: 8px; border-radius: 6px; margin-top: 8px; border: 1px dashed #475569; display: none; }
        
        .grid-box { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; background: var(--border); border: 2px solid var(--border); border-radius: 6px; overflow: hidden; margin-top: 10px; aspect-ratio: 1/1; }
        .cell { background: #0f172a; position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .cell.center { background: #172033; }
        .pos-god { position: absolute; top: 2px; left: 50%; transform: translateX(-50%); font-size: 0.7rem; color: var(--red); }
        .pos-star { position: absolute; top: 25%; left: 50%; transform: translateX(-50%); font-size: 0.85rem; color: var(--accent); font-weight: 500;}
        .pos-door { position: absolute; bottom: 25%; left: 50%; transform: translateX(-50%); font-size: 0.9rem; color: var(--gold); font-weight: bold; }
        .pos-stem-t { position: absolute; top: 4px; right: 4px; font-size: 1rem; font-weight: bold; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.8); }
        .pos-stem-d { position: absolute; bottom: 4px; left: 4px; font-size: 1rem; font-weight: bold; color: #94a3b8; }
        .pos-num { position: absolute; bottom: 2px; right: 2px; font-size: 0.6rem; color: #334155; opacity: 0.5; }
        
        #loader { text-align: center; color: var(--accent); margin-top: 30px; font-size: 0.9rem; padding: 20px;}
        .spinner { width: 40px; height: 40px; border: 4px solid #334155; border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .error-notice { background: rgba(220, 38, 38, 0.2); color: #fca5a5; padding: 12px; border-radius: 8px; margin-bottom: 12px; font-size: 0.85rem; border: 1px solid #ef4444; }
        .warning-notice { background: rgba(234, 179, 8, 0.2); color: #fde047; padding: 8px 12px; border-radius: 8px; margin-bottom: 12px; font-size: 0.8rem; border: 1px solid #eab308; display: flex; align-items: center; gap: 8px;}
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="app">
    <div class="status-bar">
        <span>V37.Dual_Mode</span>
        <span id="system-status">Booting...</span>
    </div>

    <div id="error-container"></div>
    <div id="warning-container"></div>

    <div class="controls">
        <div class="input-group">
            <input type="datetime-local" id="datetime-input">
            <button class="icon-btn" onclick="setNow()" title="å›åˆ°å½“å‰">â†»</button>
        </div>
        <div class="input-group">
            <select id="calc-method" style="flex:1;">
                <option value="chaibu">æ‹†è¡¥æ³• (Chai Bu)</option>
                <option value="zhirun">ç½®æ¶¦æ³• (Zhi Run)</option>
            </select>
        </div>
        <button id="calc-btn" class="btn" onclick="run_calc()" disabled>æ­£åœ¨åˆå§‹åŒ–...</button>
    </div>

    <div id="result-area" class="hidden">
        <div class="card" style="text-align: center; padding: 16px 0;">
            <div style="font-size: 1.2rem; font-weight: bold; color: var(--gold); margin-bottom: 6px;" id="lunar-date">--</div>
            <div style="font-size: 0.95rem; margin-bottom: 6px; letter-spacing: 1px;" id="ganzhi">--</div>
            <div style="font-size: 0.8rem; color: #94a3b8;">
                <span id="jieqi">--</span> <span style="margin:0 6px; opacity:0.3">|</span> <span id="kongwang">--</span>
            </div>
            <div style="font-size: 0.75rem; color: var(--accent); margin-top: 4px; font-family: monospace;" id="jieqi-exact-time"></div>
            
            <div id="zhirun-info-box">
                <div class="info-row" style="font-size: 0.8rem; color: #cbd5e1;">
                    <span>ç¬¦å¤´: <span id="futou-val" class="highlight">--</span></span>
                    <span id="chaoshen-status">--</span>
                </div>
                <div style="font-size: 0.75rem; color: #94a3b8; text-align: left; margin-top: 4px;">
                    ç§¯æ—¥: <span id="accum-days">--</span> (è¶…ç¥&gt;9å¤©ä¸”é€¢äºŒè‡³å‰éœ€ç½®æ¶¦)
                </div>
            </div>
        </div>

        <div class="card">
            <div class="info-row">
                <span>å±€æ•°: <span id="ju-name" class="highlight">--</span></span>
                <span>æœˆå°†: <span id="jiang" class="accent">--</span></span>
            </div>
            <div class="info-row">
                <span>å€¼ç¬¦: <span id="zhifu" class="red-text">--</span></span>
                <span>å€¼ä½¿: <span id="zhishi" class="highlight">--</span></span>
            </div>
            <div style="border-top: 1px solid #334155; margin: 8px 0; opacity: 0.3;"></div>
            <div class="info-row" style="font-size: 0.8rem;">
                <span>çœŸé»„ç»: <span id="solar-lon" class="data-val">--</span></span>
                <span>æ–—æŸ„: <span id="dubhe-ang" class="data-val">--</span></span>
            </div>
            <div class="info-row" style="font-size: 0.8rem;">
                <span>æ—¶å·®(EOT): <span id="eot" class="data-val">--</span></span>
                <span style="font-size: 0.7rem; color:#475569">Meeus Algorithm</span>
            </div>
        </div>

        <div class="grid-box" id="grid-container"></div>
        <div style="text-align: center; font-size: 0.7rem; color: #475569; margin-top: 12px;">
            <span id="coords">--</span>
        </div>
    </div>

    <div id="loader">
        <div class="spinner"></div>
        <p style="font-weight:bold; color:#fff;">æ­£åœ¨è¯»å–æœ¬åœ°ç®—æ³•åº“...</p>
        <p style="font-size: 0.75rem; color: #94a3b8; margin-top:8px;" id="log-msg">Step 1: å¯åŠ¨...</p>
    </div>
</div>

<py-config>
    packages = []
</py-config>

<py-script>
import js
import micropip
import asyncio
import datetime
import math
import json

def log(msg):
    js.document.getElementById('log-msg').innerText = msg

async def init_engine():
    try:
        file_url = "./lunar_python-1.4.8-py3-none-any.whl"
        log(f"Step 2: åŠ è½½æ–‡ä»¶ {file_url}...")
        await micropip.install(file_url)
        
        log("Step 3: å¯¼å…¥æ¨¡å—...")
        global Lunar, Solar, JieQi
        from lunar_python import Lunar, Solar, JieQi
        
        log("Step 4: å°±ç»ªï¼")
        js.window.init_complete()
    except Exception as e:
        log("âŒ åŠ è½½å¤±è´¥")
        js.window.show_error(f"æœ¬åœ°æ–‡ä»¶åŠ è½½å¤±è´¥: {str(e)}")

asyncio.ensure_future(init_engine())

GAN = ["ç”²", "ä¹™", "ä¸™", "ä¸", "æˆŠ", "å·±", "åºš", "è¾›", "å£¬", "ç™¸"]
ZHI = ["å­", "ä¸‘", "å¯…", "å¯", "è¾°", "å·³", "åˆ", "æœª", "ç”³", "é…‰", "æˆŒ", "äº¥"]
STARS = ['', 'å¤©è“¬', 'å¤©èŠ®', 'å¤©å†²', 'å¤©è¾…', 'å¤©ç¦½', 'å¤©å¿ƒ', 'å¤©æŸ±', 'å¤©ä»»', 'å¤©è‹±'] 
DOORS = ['', 'ä¼‘é—¨', 'æ­»é—¨', 'ä¼¤é—¨', 'æœé—¨', '', 'å¼€é—¨', 'æƒŠé—¨', 'ç”Ÿé—¨', 'æ™¯é—¨']
GODS = ['å€¼ç¬¦', 'è£è›‡', 'å¤ªé˜´', 'å…­åˆ', 'ç™½è™', 'ç„æ­¦', 'ä¹åœ°', 'ä¹å¤©']
JU_MAP = {'å†¬è‡³':[1,7,4], 'å°å¯’':[2,8,5], 'å¤§å¯’':[3,9,6], 'ç«‹æ˜¥':[8,5,2], 'é›¨æ°´':[9,6,3], 'æƒŠè›°':[1,7,4], 'æ˜¥åˆ†':[3,9,6], 'æ¸…æ˜':[4,1,7], 'è°·é›¨':[5,2,8], 'ç«‹å¤':[4,1,7], 'å°æ»¡':[5,2,8], 'èŠ’ç§':[6,3,9], 'å¤è‡³':[9,3,6], 'å°æš‘':[8,2,5], 'å¤§æš‘':[7,1,4], 'ç«‹ç§‹':[2,5,8], 'å¤„æš‘':[1,4,7], 'ç™½éœ²':[9,3,6], 'ç§‹åˆ†':[7,1,4], 'å¯’éœ²':[6,9,3], 'éœœé™':[5,8,2], 'ç«‹å†¬':[6,9,3], 'å°é›ª':[5,8,2], 'å¤§é›ª':[4,7,1]}

class PreciseAstronomy:
    @staticmethod
    def get_lon(dt):
        y, m, d = dt.year, dt.month, dt.day
        h = dt.hour + dt.minute/60.0 + dt.second/3600.0
        if m <= 2: y -= 1; m += 12
        A = int(y / 100)
        B = 2 - A + int(A / 4)
        JD = int(365.25 * (y + 4716)) + int(30.6001 * (m + 1)) + d + h / 24.0 + B - 1524.5
        T = (JD - 2451545.0) / 36525.0
        L0 = 280.46646 + 36000.76983 * T + 0.0003032 * T**2
        L0 = L0 % 360
        M = 357.52911 + 35999.05029 * T - 0.0001537 * T**2
        M_rad = math.radians(M)
        C = (1.914602 - 0.004817 * T - 0.000014 * T**2) * math.sin(M_rad) + \
            (0.019993 - 0.000101 * T) * math.sin(2 * M_rad) + \
            0.000289 * math.sin(3 * M_rad)
        true_lon = L0 + C
        return true_lon % 360.0

class QimenEngine:
    def _get_yuan_by_zhi(self, zhi_str):
        # æ‹†è¡¥/ç½®æ¶¦é€šç”¨å…ƒè¿åˆ¤å®š
        # å­åˆå¯é…‰(0,6,3,9) -> ä¸Šå…ƒ(0)
        # å¯…ç”³å·³äº¥(2,8,5,11) -> ä¸­å…ƒ(1)
        # è¾°æˆŒä¸‘æœª(4,10,1,7) -> ä¸‹å…ƒ(2)
        if zhi_str in ['å­', 'åˆ', 'å¯', 'é…‰']: return 0
        elif zhi_str in ['å¯…', 'ç”³', 'å·³', 'äº¥']: return 1
        return 2

    def _get_chaibu_params(self, lunar, current_jie_name):
        # æ‹†è¡¥æ³•ï¼š
        # 1. èŠ‚æ°”ä¸¥æ ¼æŒ‰ç…§å½“å‰æ—¶é—´ç‚¹
        # 2. å…ƒè¿ä¸¥æ ¼æŒ‰ç…§å½“å‰æ—¥æ”¯
        gz = lunar.getEightChar()
        day_zhi = gz.getDayZhi()
        yuan = self._get_yuan_by_zhi(day_zhi)
        
        # å±€æ•°
        if current_jie_name not in JU_MAP: current_jie_name = 'å†¬è‡³'
        ju_num = JU_MAP[current_jie_name][yuan]
        
        return {
            "term_name": current_jie_name,
            "ju_num": ju_num,
            "yuan": yuan,
            "extra_info": None
        }

    def _get_zhirun_params(self, lunar, current_dt):
        # ç½®æ¶¦æ³•ï¼š
        # 1. å¯»æ‰¾ç¬¦å¤´ (ç”²/å·±)
        gz = lunar.getEightChar()
        day_gan = gz.getDayGan()
        day_zhi = gz.getDayZhi()
        day_gan_idx = GAN.index(day_gan)
        
        # å›æº¯æ‰¾åˆ°ç¬¦å¤´æ—¥
        offset = day_gan_idx % 5 # è·ç¦»æœ€è¿‘çš„ç”²æˆ–å·±çš„å¤©æ•°
        # è®¡ç®—ç¬¦å¤´çš„ datetime
        futou_dt = current_dt - datetime.timedelta(days=offset)
        # æ„é€ ç¬¦å¤´çš„ Solar å¯¹è±¡ä»¥ä¾¿è·å–å®ƒçš„èŠ‚æ°”
        futou_solar = Solar.fromYmdHms(futou_dt.year, futou_dt.month, futou_dt.day, 0, 0, 0)
        futou_lunar = futou_solar.getLunar()
        
        futou_ganzhi = futou_lunar.getEightChar().getDay() # ä¾‹å¦‚ "ç”²å­"
        futou_zhi = futou_lunar.getEightChar().getDayZhi()
        
        # 2. åˆ¤æ–­ç¬¦å¤´æ‰€åœ¨çš„èŠ‚æ°” (æ³¨æ„ï¼šæ˜¯ç¬¦å¤´é‚£å¤©åº”è¯¥å±äºå“ªä¸ªèŠ‚æ°”ï¼Œçœ‹å®ƒå’ŒèŠ‚æ°”äº¤æ¥ç‚¹çš„å…³ç³»)
        # é€»è¾‘ï¼šè·å–ç¬¦å¤´æ—¶åˆ» å‰é¢æœ€è¿‘çš„ä¸€ä¸ªèŠ‚æ°”
        # lunar-python çš„ getPrevJieQi(True) åŒ…å«å½“å¤©
        prev_jie = futou_lunar.getPrevJieQi(True) 
        next_jie = futou_lunar.getNextJieQi(True)
        
        # è·å–è¯¥èŠ‚æ°”çš„å…·ä½“äº¤æ¥æ—¶é—´
        jie_solar = prev_jie.getSolar()
        jie_dt = datetime.datetime(jie_solar.getYear(), jie_solar.getMonth(), jie_solar.getDay(), 
                                 jie_solar.getHour(), jie_solar.getMinute(), jie_solar.getSecond())
        
        # è®¡ç®— è¶…ç¥/æ¥æ°”
        # ç¬¦å¤´æ—¶é—´ - èŠ‚æ°”æ—¶é—´
        # å¦‚æœ ç¬¦å¤´ åœ¨ èŠ‚æ°” åï¼Œæ˜¯æ­£æ¥æ°”ï¼Ÿ
        # å¤æ³•ï¼š
        # ç¬¦å¤´ å…ˆåˆ°ï¼ŒèŠ‚æ°” æœªåˆ° -> è¶…ç¥ (ç¬¦å¤´æ—¥æœŸ < èŠ‚æ°”æ—¥æœŸ)
        # èŠ‚æ°” å…ˆåˆ°ï¼Œç¬¦å¤´ æœªåˆ° -> æ¥æ°” (èŠ‚æ°”æ—¥æœŸ < ç¬¦å¤´æ—¥æœŸ)
        # ä¹Ÿå°±æ˜¯ diff = èŠ‚æ°”æ—¶é—´ - ç¬¦å¤´æ—¶é—´
        # å¦‚æœ diff > 0 (èŠ‚æ°”æ™šäºç¬¦å¤´)ï¼Œè¯´æ˜ç¬¦å¤´æ—©åˆ°äº† -> è¶…ç¥
        
        # æˆ‘ä»¬ç”¨ total_seconds è®¡ç®—
        delta_days = (jie_dt - futou_dt).total_seconds() / 86400.0
        
        # æ³¨æ„ï¼šè¿™é‡Œ futou_dt æ˜¯å½“å¤©çš„ 00:00ã€‚èŠ‚æ°”å¯èƒ½æ˜¯ 8å· 07:00ã€‚
        # å¦‚æœ ç¬¦å¤´æ˜¯ 8å·ï¼ŒèŠ‚æ°”æ˜¯ 8å·07:00ã€‚ èŠ‚æ°”-ç¬¦å¤´ = 0.29å¤©ã€‚æ­£æ•°ã€‚
        # è¯´æ˜ç¬¦å¤´(00:00)æ¯”èŠ‚æ°”(07:00)æ—© -> è¶…ç¥ã€‚
        
        is_chao_shen = delta_days > 0 
        abs_days = abs(delta_days)
        
        # 3. ç¡®å®šèŠ‚æ°”åç§°
        # é»˜è®¤ä½¿ç”¨è¯¥èŠ‚æ°”
        use_term_name = prev_jie.getName()
        
        # 4. ç½®æ¶¦åˆ¤å®š (Leap Rule)
        # åªæœ‰åœ¨ èŠ’ç§(Summer) æˆ– å¤§é›ª(Winter) é™„è¿‘ï¼Œä¸” è¶…ç¥å¤©æ•° > 9 æ—¶ï¼Œæ‰ç½®æ¶¦
        # ç½®æ¶¦æ“ä½œï¼šä½¿ç”¨ ä¸Šä¸€ä¸ªèŠ‚æ°” çš„å±€ï¼Œè€Œä¸æ˜¯å½“å‰çš„ã€‚
        is_leaping = False
        
        # ç®€å•çš„ç½®æ¶¦è§¦å‘æ£€æµ‹
        # å¦‚æœè¶…ç¥è¶…è¿‡9å¤©ï¼Œä¸”å½“å‰èŠ‚æ°”å˜æˆäº† å¤è‡³ æˆ– å†¬è‡³ï¼Œåˆ™è¯´æ˜ä¹‹å‰æ²¡ç½®æ¶¦ï¼Œéœ€è¦åœ¨è¿™é‡Œè¡¥ï¼Ÿ
        # æˆ–è€…è¯´ï¼šåœ¨èŠ’ç§/å¤§é›ªæ—¶ï¼Œå¦‚æœè¶…ç¥>9å¤©ï¼Œå°±ä¸æ¢èŠ’ç§/å¤§é›ªå±€ï¼Œè€Œæ˜¯é‡å¤å°æ»¡/å°é›ªï¼Ÿ
        # å¸¸è§çš„ç½®æ¶¦æ˜¯åœ¨ èŠ’ç§/å¤§é›ª ä¹‹åå¤šç”¨ä¸€æ°”ã€‚
        
        # è¿™é‡Œé‡‡ç”¨ä¸¥è°¨åˆ¤æ–­ï¼š
        # å¦‚æœ è¶…ç¥ > 9å¤©ï¼Œä¸”å½“å‰è‡ªç„¶èŠ‚æ°”æ˜¯ 'å¤è‡³' (è¯´æ˜å¤è‡³åˆ°äº†ï¼Œä½†ç¬¦å¤´è¶…å¤ªå¤šäº†ï¼Œè¿˜æ²¡æ³•æ¢å¤è‡³å±€ï¼Œå¾—å…ˆæŠŠèŠ’ç§é—°å®Œ)
        # æˆ–è€…æ˜¯ 'å†¬è‡³'
        # å®é™…ä¸Šç½®æ¶¦é€šå¸¸å‘ç”Ÿåœ¨ èŠ’ç§ åï¼Œå¤è‡³ å‰ã€‚
        
        # ç®€åŒ–ç®—æ³• v1: 
        # å¦‚æœè¶…ç¥ > 9å¤©ï¼Œä¸” use_term_name æ˜¯ 'å¤è‡³'ï¼Œå¼ºåˆ¶å›é€€åˆ° 'èŠ’ç§' (å³ç½®æ¶¦)
        # å¦‚æœè¶…ç¥ > 9å¤©ï¼Œä¸” use_term_name æ˜¯ 'å†¬è‡³'ï¼Œå¼ºåˆ¶å›é€€åˆ° 'å¤§é›ª'
        
        if is_chao_shen and abs_days > 9:
            if use_term_name == 'å¤è‡³':
                use_term_name = 'èŠ’ç§'
                is_leaping = True
            elif use_term_name == 'å†¬è‡³':
                use_term_name = 'å¤§é›ª'
                is_leaping = True
            # å…¶ä»–èŠ‚æ°”é€šå¸¸é¡ºæ¨ï¼Œåªæœ‰äºŒè‡³æ˜¯é˜´é˜³è½¬æ¢çš„å…³é”®ç‚¹ï¼Œå¿…é¡»å¯¹é½
        
        # 5. å®šå…ƒ (æ³¨æ„ï¼šç½®æ¶¦æ³• ä¸¥æ ¼ç”¨ ç¬¦å¤´åœ°æ”¯ å®šå…ƒ)
        yuan = self._get_yuan_by_zhi(futou_zhi)
        
        if use_term_name not in JU_MAP: use_term_name = 'å†¬è‡³'
        ju_num = JU_MAP[use_term_name][yuan]
        
        return {
            "term_name": use_term_name,
            "ju_num": ju_num,
            "yuan": yuan,
            "extra_info": {
                "futou": futou_ganzhi,
                "chaoshen": is_chao_shen,
                "days": f"{abs_days:.1f}",
                "leaping": is_leaping,
                "raw_term": prev_jie.getName()
            }
        }

    def run(self, year, month, day, hour, minute, lat, lon, method):
        try:
            dt_obj = datetime.datetime(year, month, day, hour, minute)
            doy = dt_obj.timetuple().tm_yday
            b = (2 * math.pi / 365.24) * (doy - 81)
            eot = 9.87 * math.sin(2*b) - 7.53 * math.cos(b) - 1.5 * math.sin(b)
            tst = dt_obj + datetime.timedelta(minutes=eot + (lon-120)*4)
            solar = Solar.fromYmdHms(tst.year, tst.month, tst.day, tst.hour, tst.minute, 0)
            lunar = solar.getLunar()
            
            # åŸºç¡€å¤©æ–‡èŠ‚æ°”è®¡ç®— (ç”¨äºæ˜¾ç¤ºå’Œæ‹†è¡¥åŸºå‡†)
            prev_jie = lunar.getPrevJieQi(True)
            jie_solar = prev_jie.getSolar()
            term_name = prev_jie.getName()
            exact_jie_str = f"{term_name}: {jie_solar.toYmdHms()}"
            
            # --- æ ¸å¿ƒåˆ†æ”¯ ---
            if method == 'zhirun':
                params = self._get_zhirun_params(lunar, dt_obj)
            else:
                params = self._get_chaibu_params(lunar, term_name)
                
            final_term = params['term_name']
            ju = params['ju_num']
            yuan = params['yuan']
            extra = params['extra_info']

            # è®¡ç®—æ’ç›˜æ•°æ®
            real_yang = final_term in ['å†¬è‡³','å°å¯’','å¤§å¯’','ç«‹æ˜¥','é›¨æ°´','æƒŠè›°','æ˜¥åˆ†','æ¸…æ˜','è°·é›¨','ç«‹å¤','å°æ»¡','èŠ’ç§']
            
            stems_order = ['æˆŠ', 'å·±', 'åºš', 'è¾›', 'å£¬', 'ç™¸', 'ä¸', 'ä¸™', 'ä¹™']
            dp = {} 
            for i, s in enumerate(stems_order):
                pos = ((ju - 1 + i) % 9) + 1 if real_yang else ((ju - 1 - i) % 9) + 1
                if pos <= 0: pos += 9
                if pos == 0: pos = 9
                dp[pos] = s
            
            gz = lunar.getEightChar()
            h_gan = gz.getTimeGan()
            h_zhi = gz.getTimeZhi()
            h_zhi_idx = ZHI.index(h_zhi)
            head_zhi_idx = (h_zhi_idx - GAN.index(h_gan)) % 12 
            xun_map = {0:'æˆŠ', 10:'å·±', 8:'åºš', 6:'è¾›', 4:'å£¬', 2:'ç™¸'}
            xun_gan = xun_map.get(head_zhi_idx, 'æˆŠ')
            pos_xun = 1
            for p, s in dp.items():
                if s == xun_gan: pos_xun = p; break
            zhifu_star = STARS[pos_xun] 
            zhishi_door = DOORS[pos_xun] if pos_xun != 5 else "æ­»é—¨" 
            if pos_xun == 5: pos_xun = 2 
            target_stem = h_gan if h_gan != 'ç”²' else xun_gan
            pos_sky_dest = 1 
            for p, s in dp.items():
                if s == target_stem: pos_sky_dest = p; break
            path = [1,8,3,4,9,2,7,6] 
            full_grid = {}
            for i in range(1, 10):
                full_grid[i] = {"stem_d": dp.get(i, ""), "stem_t": "", "star": "", "door": "", "god": ""}
            try: start_idx = path.index(pos_sky_dest)
            except: start_idx = 0 
            for i in range(8):
                p_idx = (start_idx + i) % 8 if real_yang else (start_idx - i) % 8 
                full_grid[path[p_idx]]["god"] = GODS[i]
            target_star_name = "å¤©èŠ®" if zhifu_star == "å¤©ç¦½" else zhifu_star
            base_stars = ["å¤©è“¬","å¤©ä»»","å¤©å†²","å¤©è¾…","å¤©è‹±","å¤©èŠ®","å¤©æŸ±","å¤©å¿ƒ"]
            try: s_idx = base_stars.index(target_star_name)
            except: s_idx = 0
            for i in range(8):
                curr_star = base_stars[(s_idx + i) % 8]
                curr_palace = path[(start_idx + i) % 8]
                full_grid[curr_palace]["star"] = curr_star
                if curr_star == "å¤©èŠ®": full_grid[curr_palace]["star"] = "å¤©èŠ®(ç¦½)"
                orig_p = { "å¤©è“¬":1, "å¤©ä»»":8, "å¤©å†²":3, "å¤©è¾…":4, "å¤©è‹±":9, "å¤©èŠ®":2, "å¤©æŸ±":7, "å¤©å¿ƒ":6 }.get(curr_star, 1)
                stem_on_sky = dp.get(orig_p, "")
                if orig_p == 2:
                    stem_5 = dp.get(5, "")
                    if stem_5: stem_on_sky = stem_on_sky + stem_5
                full_grid[curr_palace]["stem_t"] = stem_on_sky
            full_grid[5]["stem_t"] = "" 
            step = (h_zhi_idx - head_zhi_idx) % 12
            try:
                raw_pos_xun = 1
                for p, s in dp.items():
                    if s == xun_gan: raw_pos_xun = p; break
                if raw_pos_xun == 5: raw_pos_xun = 2
                d_start_idx = path.index(raw_pos_xun)
            except: d_start_idx = 0
            fly_step = step if real_yang else -step
            dest_idx = (d_start_idx + fly_step) % 8
            base_doors = ["ä¼‘é—¨","ç”Ÿé—¨","ä¼¤é—¨","æœé—¨","æ™¯é—¨","æ­»é—¨","æƒŠé—¨","å¼€é—¨"]
            current_zhishi_name = zhishi_door if zhishi_door != "" else "æ­»é—¨"
            try: bd_idx = base_doors.index(current_zhishi_name)
            except: bd_idx = 5 
            for i in range(8):
                curr_door = base_doors[(bd_idx + i) % 8]
                curr_p = path[(dest_idx + i) % 8]
                full_grid[curr_p]["door"] = curr_door

            slon = PreciseAstronomy.get_lon(tst) 
            dubhe = (slon + 90.0) % 360.0    
            jiang_idx = (10 - int(slon / 30)) % 12
            
            return json.dumps({
                "lunar": f"å†œå† {lunar.getMonthInChinese()}æœˆ{lunar.getDayInChinese()}",
                "ganzhi": f"{gz.getYear()}å¹´ {gz.getMonth()}æœˆ {gz.getDay()}æ—¥ {gz.getTime()}æ—¶",
                "jieqi": f"{final_term}",
                "exact_jieqi": f"å®é™…èŠ‚æ°”: {jie_solar.toYmdHms()}",
                "kongwang": f"æ—¥ç©º:{lunar.getDayXunKong()} æ—¶ç©º:{lunar.getTimeXunKong()}",
                "info": { "lon": f"{slon:.2f}Â°", "dubhe": f"{dubhe:.2f}Â°", "eot": f"{eot:.1f}m", "coords": f"{lat:.2f}, {lon:.2f}" },
                "ju": { "name": f"{'é˜³' if real_yang else 'é˜´'}é{ju}å±€ {['ä¸Š','ä¸­','ä¸‹'][yuan]}å…ƒ", "zhifu": zhifu_star, "zhishi": zhishi_door, "jiang": ZHI[jiang_idx] + "å°†" },
                "grid": full_grid,
                "zhirun_info": extra
            })
        except Exception as e:
            return json.dumps({"error": str(e)})

engine = QimenEngine()
def python_entry(y, m, d, h, minute, lat, lon, method):
    res_str = engine.run(int(y), int(m), int(d), int(h), int(minute), float(lat), float(lon), str(method))
    js.render_result(res_str)

js.window.python_entry = python_entry
</py-script>

<script>
    const btn = document.getElementById('calc-btn');
    const dateInput = document.getElementById('datetime-input');
    const methodSelect = document.getElementById('calc-method');
    const statusSpan = document.getElementById('system-status');
    let pyReady = false;

    function setNow() {
        const now = new Date();
        const offset = now.getTimezoneOffset() * 60000;
        const localIso = new Date(now - offset).toISOString().slice(0, 16);
        dateInput.value = localIso;
    }
    setNow();

    window.init_complete = function() {
        document.getElementById('loader').style.display = 'none';
        btn.innerText = "ç«‹å³æ’ç›˜";
        btn.disabled = false;
        pyReady = true;
        statusSpan.innerText = "Ready";
        statusSpan.style.color = "#4ade80";
    }

    window.show_error = function(msg) {
        document.getElementById('error-container').innerHTML = `<div class="error-notice">âš ï¸ ${msg.replace(/\n/g, '<br>')}</div>`;
        statusSpan.innerText = "Error";
        statusSpan.style.color = "#f87171";
    }

    window.show_warning = function(msg) {
        document.getElementById('warning-container').innerHTML = `<div class="warning-notice"><span>ğŸ“</span> ${msg}</div>`;
    }

    window.render_result = function(jsonStr) {
        const data = JSON.parse(jsonStr);
        if(data.error) {
            window.show_error("è®¡ç®—é”™è¯¯: " + data.error);
            return;
        }
        document.getElementById('result-area').classList.remove('hidden');
        document.getElementById('error-container').innerHTML = ''; 
        
        document.getElementById('lunar-date').innerText = data.lunar;
        document.getElementById('ganzhi').innerText = data.ganzhi;
        document.getElementById('jieqi').innerText = data.jieqi;
        document.getElementById('jieqi-exact-time').innerText = data.exact_jieqi; 
        
        document.getElementById('kongwang').innerText = data.kongwang;
        document.getElementById('solar-lon').innerText = data.info.lon;
        document.getElementById('dubhe-ang').innerText = data.info.dubhe;
        document.getElementById('eot').innerText = data.info.eot;
        document.getElementById('coords').innerText = data.info.coords;
        document.getElementById('ju-name').innerText = data.ju.name;
        document.getElementById('zhifu').innerText = data.ju.zhifu;
        document.getElementById('zhishi').innerText = data.ju.zhishi;
        document.getElementById('jiang').innerText = data.ju.jiang;
        
        // ç½®æ¶¦æ³•ä¿¡æ¯æ˜¾ç¤ºé€»è¾‘
        const zrBox = document.getElementById('zhirun-info-box');
        if(data.zhirun_info) {
            zrBox.style.display = 'block';
            document.getElementById('futou-val').innerText = data.zhirun_info.futou;
            
            const isChao = data.zhirun_info.chaoshen;
            const days = data.zhirun_info.days;
            const statusSpan = document.getElementById('chaoshen-status');
            
            if(isChao) {
                statusSpan.innerText = "è¶…ç¥";
                statusSpan.className = "accent";
            } else {
                statusSpan.innerText = "æ¥æ°”";
                statusSpan.className = "green-text";
            }
            
            let desc = `${days} å¤©`;
            if(data.zhirun_info.leaping) {
                desc += " (å·²ç½®æ¶¦)";
                document.getElementById('accum-days').style.color = "#f87171";
            } else {
                document.getElementById('accum-days').style.color = "#cbd5e1";
            }
            document.getElementById('accum-days').innerText = desc;
        } else {
            zrBox.style.display = 'none';
        }

        const grid = document.getElementById('grid-container');
        grid.innerHTML = '';
        const mapOrder = [4, 9, 2, 3, 5, 7, 8, 1, 6]; 
        mapOrder.forEach(idx => {
            const cell = document.createElement('div');
            cell.className = 'cell';
            if(idx === 5) cell.className += ' center';
            const g = data.grid[idx.toString()];
            if(g) {
                if(g.god) cell.innerHTML += `<div class="pos-god">${g.god}</div>`;
                if(g.star) cell.innerHTML += `<div class="pos-star">${g.star}</div>`;
                if(g.door) cell.innerHTML += `<div class="pos-door">${g.door}</div>`;
                if(g.stem_t) {
                    const stems = g.stem_t.split('');
                    let html = stems.length > 1 ? `<div class="pos-stem-t" style="font-size:0.85rem; top:6px;">${g.stem_t}</div>` : `<div class="pos-stem-t">${g.stem_t}</div>`;
                    cell.innerHTML += html;
                }
                if(g.stem_d) cell.innerHTML += `<div class="pos-stem-d">${g.stem_d}</div>`;
            }
            cell.innerHTML += `<div class="pos-num">${idx}</div>`;
            grid.appendChild(cell);
        });
    }

    window.run_calc = function() {
        if(!pyReady) return;
        document.getElementById('warning-container').innerHTML = '';
        
        const dt = new Date(dateInput.value);
        const method = methodSelect.value;
        const defaultLat = 39.9042, defaultLon = 116.4074;

        if (navigator.geolocation) {
            btn.innerText = "å®šä½ä¸­..."; btn.disabled = true;
            navigator.geolocation.getCurrentPosition(
                (pos) => { 
                    btn.innerText = "ç«‹å³æ’ç›˜"; btn.disabled = false; 
                    window.python_entry(dt.getFullYear(), dt.getMonth()+1, dt.getDate(), dt.getHours(), dt.getMinutes(), pos.coords.latitude, pos.coords.longitude, method); 
                },
                (err) => { 
                    console.warn("Location error:", err);
                    window.python_entry(dt.getFullYear(), dt.getMonth()+1, dt.getDate(), dt.getHours(), dt.getMinutes(), defaultLat, defaultLon, method);
                    btn.innerText = "ç«‹å³æ’ç›˜"; btn.disabled = false;
                    window.show_warning("å®šä½è¶…æ—¶ï¼Œå·²ä½¿ç”¨é»˜è®¤åæ ‡ (åŒ—äº¬)");
                }, 
                { timeout: 5000 }
            );
        } else {
            window.python_entry(dt.getFullYear(), dt.getMonth()+1, dt.getDate(), dt.getHours(), dt.getMinutes(), defaultLat, defaultLon, method);
            window.show_warning("æµè§ˆå™¨ä¸æ”¯æŒå®šä½ï¼Œä½¿ç”¨é»˜è®¤åæ ‡");
        }
    }
</script>
</body>
</html>
