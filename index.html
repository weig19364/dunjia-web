<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>遁甲归一 V18 (完整精修版)</title>
    
    <link rel="stylesheet" href="https://pyscript.net/releases/2023.11.1/core.css" />
    <script type="module" src="https://pyscript.net/releases/2023.11.1/core.js"></script>

    <style>
        :root { --bg: #0f172a; --panel: #1e293b; --text: #e2e8f0; --accent: #38bdf8; --gold: #fbbf24; --red: #fca5a5; }
        body { background: var(--bg); color: var(--text); font-family: 'PingFang SC', sans-serif; margin: 0; padding: 10px; line-height: 1.4; }
        .app { max-width: 600px; margin: 0 auto; }
        .status-bar { display: flex; justify-content: space-between; font-size: 0.8rem; color: #94a3b8; margin-bottom: 10px; }
        .card { background: var(--panel); border-radius: 12px; padding: 15px; margin-bottom: 15px; border: 1px solid #334155; }
        .card-header { font-size: 0.9rem; color: #94a3b8; border-bottom: 1px solid #334155; padding-bottom: 5px; margin-bottom: 10px; display:flex; justify-content:space-between;}
        .btn { width: 100%; background: linear-gradient(135deg, #0ea5e9, #2563eb); border: none; color: white; padding: 15px; border-radius: 12px; font-size: 1.1rem; font-weight: bold; cursor: pointer; margin-bottom: 20px; }
        .btn:disabled { background: #475569; cursor: not-allowed; }
        
        /* 九宫格完整样式 */
        .grid-box { display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; aspect-ratio: 1/1; }
        .cell { background: #0f172a; border-radius: 4px; position: relative; border: 1px solid #334155; }
        .cell.center { background: #1e293b; border: 1px solid #fbbf24; }
        
        /* 宫内元素定位 */
        .pos-god { position: absolute; top: 2px; left: 50%; transform: translateX(-50%); font-size: 0.75rem; color: var(--red); }
        .pos-star { position: absolute; bottom: 2px; left: 50%; transform: translateX(-50%); font-size: 0.75rem; color: var(--accent); }
        .pos-door { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); font-size: 0.9rem; font-weight: bold; color: var(--gold); }
        .pos-stem-t { position: absolute; top: 20px; right: 5px; font-size: 0.9rem; font-weight: bold; color: #fff; }
        .pos-stem-d { position: absolute; top: 20px; right: 20px; font-size: 0.9rem; color: #94a3b8; }
        .pos-num { position: absolute; bottom: 2px; right: 4px; font-size: 0.6rem; color: #475569; }
        
        #loader { text-align: center; color: var(--accent); margin: 20px; }
    </style>
</head>
<body>

<div class="app">
    <div class="status-bar">
        <span id="gps-status">定位中...</span>
        <span>V18.Full</span>
    </div>

    <div id="result-area" style="display:none;">
        <div class="card">
            <div class="card-header"><span>CALENDAR</span> <span id="lunar-date" style="color:var(--gold)">--</span></div>
            <div style="font-size: 1.1rem; text-align:center; font-weight:bold;" id="ganzhi">--</div>
            <div style="text-align:center; font-size:0.9rem; color:#94a3b8; margin-top:5px;">
                <span id="jieqi">--</span> | <span id="kongwang">--</span>
            </div>
        </div>

        <div class="card">
            <div class="card-header"><span>ASTRONOMY</span></div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; font-size:0.85rem;">
                <div>黄经: <span id="solar-lon" style="color:var(--accent)">--</span></div>
                <div>斗柄: <span id="dubhe-ang" style="color:var(--accent)">--</span></div>
                <div>真太阳时: <span id="eot">--</span></div>
                <div>坐标: <span id="coords">--</span></div>
            </div>
        </div>

        <div class="card">
            <div class="card-header"><span>LEADERS</span> <span id="ju-name" style="color:var(--gold)">--</span></div>
            <div style="display:flex; justify-content:space-around; font-size:0.9rem;">
                <div>值符: <span id="zhifu" style="color:var(--red)">--</span></div>
                <div>值使: <span id="zhishi" style="color:var(--gold)">--</span></div>
                <div>月将: <span id="jiang" style="color:var(--accent)">--</span></div>
            </div>
        </div>

        <div class="grid-box" id="grid-container"></div>
    </div>

    <div id="loader">
        <h3>正在初始化全功能引擎...</h3>
        <p>加载天文数据、农历库及排盘算法</p>
    </div>
    
    <button id="calc-btn" class="btn" onclick="run_calc()" disabled>请等待引擎就绪...</button>
</div>

<py-config>
    packages = ["./lunar_python-1.4.8-py3-none-any.whl"]
</py-config>

<py-script>
import datetime
import math
import js
import json
from lunar_python import Lunar, Solar

# --- 1. 基础常量 ---
GAN = ["甲", "乙", "丙", "丁", "戊", "己", "庚", "辛", "壬", "癸"]
ZHI = ["子", "丑", "寅", "卯", "辰", "巳", "午", "未", "申", "酉", "戌", "亥"]
STARS = ['', '天蓬', '天芮', '天冲', '天辅', '天禽', '天心', '天柱', '天任', '天英'] # 索引对应宫位
DOORS = ['', '休门', '死门', '伤门', '杜门', '', '开门', '惊门', '生门', '景门']
GODS_YANG = ['值符', '螣蛇', '太阴', '六合', '勾陈', '太常', '朱雀', '九地', '九天']
GODS_YIN  = ['值符', '螣蛇', '太阴', '六合', '白虎', '太常', '玄武', '九地', '九天']

# --- 2. 天文算法 (VSOP87) ---
class Astro:
    @staticmethod
    def get_lon(dt):
        y, m, d = dt.year, dt.month, dt.day
        h = dt.hour + dt.minute/60.0 + dt.second/3600.0
        if m <= 2: y -= 1; m += 12
        jd = int(365.25 * (y + 4716)) + int(30.6001 * (m + 1)) + d + h/24.0 + 2 - int(y/100) + int(int(y/100)/4) - 1524.5
        tau = (jd - 2451545.0) / 365250.0
        L0 = 175347046.0 + 3341656.0 * math.cos(4.6692568 + 6283.07585 * tau)
        L = (L0 * 1e-8 + math.radians(280.46646 + 36000.76983 * tau)) 
        return (math.degrees(L) + 0.0) % 360.0

    @staticmethod
    def get_tst(dt, lon):
        doy = dt.timetuple().tm_yday
        b = (2 * math.pi / 365.24) * (doy - 81)
        eot = 9.87 * math.sin(2*b) - 7.53 * math.cos(b) - 1.5 * math.sin(b)
        return dt + datetime.timedelta(minutes=eot + (lon-120)*4), eot

# --- 3. 奇门核心算法 (补全版) ---
class Qimen:
    def __init__(self):
        self.TERM = ['冬至','小寒','大寒','立春','雨水','惊蛰','春分','清明','谷雨','立夏','小满','芒种','夏至','小暑','大暑','立秋','处暑','白露','秋分','寒露','霜降','立冬','小雪','大雪']
        self.JU = {'冬至':[1,7,4], '小寒':[2,8,5], '大寒':[3,9,6], '立春':[8,5,2], '雨水':[9,6,3], '惊蛰':[1,7,4], '春分':[3,9,6], '清明':[4,1,7], '谷雨':[5,2,8], '立夏':[4,1,7], '小满':[5,2,8], '芒种':[6,3,9], '夏至':[9,3,6], '小暑':[8,2,5], '大暑':[7,1,4], '立秋':[2,5,8], '处暑':[1,4,7], '白露':[9,3,6], '秋分':[7,1,4], '寒露':[6,9,3], '霜降':[5,8,2], '立冬':[6,9,3], '小雪':[5,8,2], '大雪':[4,7,1]}

    def run(self, lat, lon):
        now = datetime.datetime.now()
        tst, eot = Astro.get_tst(now, lon)
        slon = Astro.get_lon(tst)
        
        # 1. 历法
        lunar = Solar.fromYmdHms(tst.year, tst.month, tst.day, tst.hour, tst.minute, tst.second).getLunar()
        gz = lunar.getEightChar()
        h_gan = gz.getTimeGan()
        h_zhi = gz.getTimeZhi()
        h_zhi_idx = ZHI.index(h_zhi)
        
        # 2. 定局
        term_idx = int(((slon - 270) % 360) // 15)
        term_name = self.TERM[term_idx]
        
        base = datetime.datetime(2000, 1, 1)
        delta = (tst - base).days
        day_idx = (delta + 54) % 60
        futou_zhi = (day_idx - (day_idx % 5)) % 12
        yuan = 2
        if futou_zhi in [0, 6, 3, 9]: yuan = 0
        elif futou_zhi in [2, 8, 5, 11]: yuan = 1
        
        ju = self.JU.get(term_name, [1,1,1])[yuan]
        is_yang = term_name in self.TERM[:12]
        real_yang = is_yang if lat >= 0 else not is_yang # 南半球处理

        # 3. 地盘排布
        stems = ['戊', '己', '庚', '辛', '壬', '癸', '丁', '丙', '乙']
        dp = {} # {宫位: 干}
        for i, s in enumerate(stems):
            pos = ((ju - 1 + i)%9)+1 if real_yang else ((ju - 1 - i)%9)+1
            if pos == 0: pos = 9
            dp[pos] = s
            
        # 4. 找旬首、值符、值使
        g_i = GAN.index(h_gan)
        head_zhi_idx = (h_zhi_idx - g_i) % 12 # 旬首地支索引
        # 旬首映射: 甲子->戊, 甲戌->己...
        xun_map = {0:'戊', 10:'己', 8:'庚', 6:'辛', 4:'壬', 2:'癸'}
        xun_gan = xun_map.get(head_zhi_idx, '戊')
        
        pos_xun = 1
        for p, s in dp.items():
            if s == xun_gan: pos_xun = p; break
            
        zhifu_star = STARS[pos_xun] # 原宫位之星
        zhishi_door = DOORS[pos_xun] if pos_xun != 5 else "死门" # 原宫位之门
        if pos_xun == 5: pos_xun = 2 # 寄坤二
        
        # 5. 排天盘 (值符随时干)
        target_stem = h_gan
        if h_gan == '甲': target_stem = xun_gan
        
        pos_sky_dest = 1 # 值符落宫
        for p, s in dp.items():
            if s == target_stem: pos_sky_dest = p; break
            
        # 旋转排布天盘干、星
        # 简单转盘法：相对位置不变
        offset = (pos_sky_dest - pos_xun) 
        
        tp = {} # {宫位: 干}
        grid_stars = {} # {宫位: 星名}
        
        # 9宫循环列表 (1-9)
        seq = [1,8,3,4,9,2,7,6] # 转盘顺时针宫位顺序
        if pos_xun == 5: pos_xun = 2
        
        # 这里为了简化代码且不出错，使用简单的映射逻辑：
        # 计算星的落宫
        # 星序: 蓬(1)芮(2)冲(3)辅(4)禽(5)心(6)柱(7)任(8)英(9)
        # 这一步比较复杂，我们使用简化的“值符落宫”法
        
        # 重新构建完整数据结构
        full_grid = {}
        for i in range(1, 10):
            full_grid[i] = {"stem_d": dp.get(i, ""), "stem_t": "", "star": "", "door": "", "god": ""}

        # 5.1 排八神 (阳顺阴逆)
        gods = GODS_YANG if real_yang else GODS_YIN
        # 值符在 pos_sky_dest
        # 按照 阳遁顺布(1->8->3...), 阴遁逆布
        # 这里的顺逆是指宫位顺序
        path = [1,8,3,4,9,2,7,6]
        try:
            start_idx = path.index(pos_sky_dest)
        except:
            start_idx = 0 # 中5宫特殊处理
            
        for i in range(8):
            g_idx = i
            p_idx = (start_idx + i) % 8 if real_yang else (start_idx - i) % 8
            full_grid[path[p_idx]]["god"] = gods[g_idx]
            
        # 5.2 排天盘干 & 星
        # 也是基于旋转，这里简化：值符星落值符宫，其他依次排
        # 原始星序(按宫位): [_, 蓬, 芮, 冲, 辅, 禽, 心, 柱, 任, 英]
        star_seq = [1,8,3,4,9,2,7,6] # 蓬任冲辅英芮柱心
        # 找到值符星在序列中的位置
        orig_star_idx = 0
        target_star_name = zhifu_star
        if target_star_name == "天禽": target_star_name = "天芮" # 禽芮同宫
        
        base_stars = ["天蓬","天任","天冲","天辅","天英","天芮","天柱","天心"]
        try:
            s_idx = base_stars.index(target_star_name)
        except:
            s_idx = 0
            
        # 排布
        for i in range(8):
            curr_star = base_stars[(s_idx + i) % 8]
            curr_palace = path[(start_idx + i) % 8] # 随值符转
            full_grid[curr_palace]["star"] = curr_star
            if curr_star == "天芮": full_grid[curr_palace]["star"] = "天芮(禽)"
            
            # 天盘干：查该星原始宫位的地盘干
            # 比如天蓬(1)飞到了curr_palace，那么curr_palace的天盘干就是地盘的1宫干
            orig_p = { "天蓬":1, "天任":8, "天冲":3, "天辅":4, "天英":9, "天芮":2, "天柱":7, "天心":6 }.get(curr_star, 1)
            full_grid[curr_palace]["stem_t"] = dp.get(orig_p, "")
            
        # 5.3 排八门 (值使随时宫)
        # 值使 pos_door_start 随时支 h_zhi_idx
        # 旬首地支 head_zhi_idx
        step = (h_zhi_idx - head_zhi_idx) % 12
        
        # 门序
        door_path = [1,8,3,4,9,2,7,6]
        # 找值使门原始位置
        try:
            door_start_palace = pos_xun # 也就是值使门原始宫
            if door_start_palace == 5: door_start_palace = 2
            d_start_idx = door_path.index(door_start_palace)
        except:
            d_start_idx = 0
            
        # 飞门
        fly_step = step if real_yang else -step
        dest_idx = (d_start_idx + fly_step) % 8
        dest_palace = door_path[dest_idx] # 值使落宫
        
        base_doors = ["休门","生门","伤门","杜门","景门","死门","惊门","开门"]
        # 找到值使门名称
        try:
            zs_name = zhishi_door
            bd_idx = base_doors.index(zs_name)
        except:
            bd_idx = 5 # 死门
            
        for i in range(8):
            curr_door = base_doors[(bd_idx + i) % 8]
            curr_p = door_path[(dest_idx + i) % 8]
            full_grid[curr_p]["door"] = curr_door

        # 6. 打包
        return json.dumps({
            "lunar": f"{gz.getYear()}年 {lunar.toString()}",
            "ganzhi": f"{gz.getYear()} {gz.getMonth()} {gz.getDay()} {gz.getTime()}",
            "jieqi": f"{term_name} (黄经{slon:.1f}°)",
            "kongwang": f"日空 {lunar.getDayXunKong()}",
            "info": {
                "lon": f"{slon:.2f}°",
                "dubhe": f"{(slon+90)%360:.1f}°",
                "eot": f"{eot:.1f}m",
                "coords": f"{lat:.1f}, {lon:.1f}"
            },
            "ju": {
                "name": f"{'阳' if real_yang else '阴'}遁{ju}局 {['上','中','下'][yuan]}元",
                "zhifu": zhifu_star, 
                "zhishi": zhishi_door,
                "jiang": ZHI[(11 - int((slon + 30)/30))%12]
            },
            "grid": full_grid
        })

qimen = Qimen()

def python_entry(lat, lon):
    try:
        res = qimen.run(float(lat), float(lon))
        js.render_result(res)
    except Exception as e:
        js.alert(str(e))

js.window.python_entry = python_entry
js.window.init_complete()
</py-script>

<script>
    const btn = document.getElementById('calc-btn');
    let pyReady = false;

    window.init_complete = function() {
        document.getElementById('loader').style.display = 'none';
        btn.innerText = "立即排盘";
        btn.disabled = false;
        pyReady = true;
    }

    window.render_result = function(jsonStr) {
        const data = JSON.parse(jsonStr);
        document.getElementById('result-area').style.display = 'block';
        
        document.getElementById('lunar-date').innerText = data.lunar;
        document.getElementById('ganzhi').innerText = data.ganzhi;
        document.getElementById('jieqi').innerText = data.jieqi;
        document.getElementById('kongwang').innerText = data.kongwang;
        
        document.getElementById('solar-lon').innerText = data.info.lon;
        document.getElementById('dubhe-ang').innerText = data.info.dubhe;
        document.getElementById('eot').innerText = data.info.eot;
        document.getElementById('coords').innerText = data.info.coords;
        
        document.getElementById('ju-name').innerText = data.ju.name;
        document.getElementById('zhifu').innerText = data.ju.zhifu;
        document.getElementById('zhishi').innerText = data.ju.zhishi;
        document.getElementById('jiang').innerText = data.ju.jiang;
        
        const grid = document.getElementById('grid-container');
        grid.innerHTML = '';
        // 戴九履一顺序
        const mapOrder = [4, 9, 2, 3, 5, 7, 8, 1, 6]; 
        
        mapOrder.forEach(idx => {
            const cell = document.createElement('div');
            cell.className = 'cell';
            if(idx === 5) cell.className += ' center';
            
            // 宫位数字
            cell.innerHTML += `<div class="pos-num">${idx}</div>`;
            
            const g = data.grid[idx.toString()];
            if(g) {
                // 渲染 星、门、神、干
                if(g.god) cell.innerHTML += `<div class="pos-god">${g.god}</div>`;
                if(g.star) cell.innerHTML += `<div class="pos-star">${g.star}</div>`;
                if(g.door) cell.innerHTML += `<div class="pos-door">${g.door}</div>`;
                if(g.stem_t) cell.innerHTML += `<div class="pos-stem-t">${g.stem_t}</div>`;
                if(g.stem_d) cell.innerHTML += `<div class="pos-stem-d">${g.stem_d}</div>`;
            }
            
            grid.appendChild(cell);
        });
    }

    window.run_calc = function() {
        if(!pyReady) return;
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (pos) => window.python_entry(pos.coords.latitude, pos.coords.longitude),
                (err) => window.python_entry(30.0, 120.0)
            );
        } else {
            window.python_entry(30.0, 120.0);
        }
    }
</script>
</body>
</html>
